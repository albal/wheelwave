# WheelWave üõûüåä  
A Cloudflare-native ‚Äúsimple‚Äù PyPI index backed by R2 (no PyPI mirroring)

WheelWave publishes **only your own** Python distributions (`.whl`, `.tar.gz`) from a flat directory and serves them globally via:

- **Cloudflare Workers** for the `/simple/` index + artifact delivery
- **Cloudflare R2** for storage
- **Cloudflare CDN / DDoS protection** automatically in front of the Worker

It does **not** run `pypiserver`, and it does **not** mirror PyPI.

---

## How it works

### Storage layout in R2
WheelWave expects this object layout:

- `packages/<filename>.whl`
- `packages/<filename>.tar.gz`
- `simple/manifest-v1.json` (generated by `build_manifest.py`)

Your source directory can be **flat** (no subfolders). WheelWave infers project names from filenames.

### Public endpoints
- `GET /simple/` ‚Äî list projects
- `GET /simple/<project>/` ‚Äî list files for that project
- `GET /packages/<filename>` ‚Äî download the artifact

Example:
- `https://packages.example.com/simple/requests/`
- `https://packages.example.com/packages/requests-2.32.3-py3-none-any.whl`

---

## Requirements

- Terraform ‚â• 1.5
- Cloudflare account + zone for your domain
- A Cloudflare API token with permissions for:
  - Workers Scripts + Workers Custom Domains
  - R2 (bucket management)
  - Zone access for the hostname
- On your package build server (the machine with `/data/packages`):
  - Python 3
  - rclone (configured for R2)
  - cron

---

## Deploy (Terraform)

1) Create `terraform.tfvars` in the project root:

```hcl
cloudflare_api_token = "YOUR_CLOUDFLARE_API_TOKEN"
account_id           = "YOUR_CLOUDFLARE_ACCOUNT_ID"
zone_id              = "YOUR_CLOUDFLARE_ZONE_ID"

# where WheelWave will be served from
hostname             = "packages.example.com"

# R2 bucket used for artifacts + manifest
bucket_name          = "pypi-artifacts"
r2_location          = "WEUR"
```

Apply:

```bash
terraform init
terraform apply
```

Terraform will create:

- an R2 bucket
- a Worker script with an R2 binding
- a Worker Custom Domain for hostname (Cloudflare manages TLS/certs)

After apply, your base URL should be live:

```text
https://<hostname>/simple/
```

Configure rclone for Cloudflare R2
Create or update `~/.config/rclone/rclone.conf` on your build server:

```ini
[r2]
type = s3
provider = Cloudflare
access_key_id = YOUR_R2_ACCESS_KEY_ID
secret_access_key = YOUR_R2_SECRET_ACCESS_KEY
endpoint = https://<ACCOUNT_ID>.r2.cloudflarestorage.com
```

Quick sanity check:

```bash
rclone lsd r2:
```

### Publish packages from a flat directory
Assume your build server has:

```bash
/data/packages
  ‚îú‚îÄ‚îÄ some_pkg-1.2.3-py3-none-any.whl
  ‚îú‚îÄ‚îÄ some-pkg-1.2.3.tar.gz
  ‚îî‚îÄ‚îÄ ...
```

1) **Install scripts**
Copy these to your build server:

- `build_manifest.py` ‚Üí `/usr/local/bin/build_manifest.py`
- `pypi_r2_sync.sh` ‚Üí `/usr/local/bin/pypi_r2_sync.sh`

Then:

```bash
chmod +x /usr/local/bin/build_manifest.py
chmod +x /usr/local/bin/pypi_r2_sync.sh
```

Edit `/usr/local/bin/pypi_r2_sync.sh` and set:

- `SRC_DIR="/data/packages"`
- `RCLONE_REMOTE="r2"`
- `R2_BUCKET="pypi-artifacts"` (must match Terraform)

2) **Run once manually**

```bash
/usr/local/bin/pypi_r2_sync.sh
```

This will:

- Generate `simple/manifest-v1.json`
- Upload all `*.whl` / `*.tar.gz` to `r2:<bucket>/packages/`
- Upload the manifest to `r2:<bucket>/simple/manifest-v1.json`

### Schedule sync every 15 minutes (cron)
Edit cron for the user that has rclone configured:

```bash
crontab -e
```

Add:

```cron
*/15 * * * * /usr/local/bin/pypi_r2_sync.sh >> /var/log/wheelwave_sync.log 2>&1
```

Optional: rotate logs with logrotate if desired.

### Using the repository with pip

If you **ONLY** want your index:

```bash
pip install --index-url https://packages.example.com/simple your-package
```

If you want your index + PyPI:

```bash
pip install --extra-index-url https://packages.example.com/simple your-package
```

Note: pip does not treat `--extra-index-url` as a strict priority order.
Use unique package names to avoid conflicts with PyPI packages.

### Naming and filename expectations
WheelWave infers the project name from filenames:

- Wheels: uses the first `-` segment (`distribution-...whl`)
- Sdists: assumes `name-version.tar.gz` and uses everything except the last `-` segment as the name

For best results:

- publish standard wheels and sdists produced by `python -m build`
- avoid renaming artifacts manually

### Troubleshooting

#### `/simple/` shows ‚ÄúNo manifest uploaded yet‚Äù
Verify the manifest exists in R2:

```bash
rclone cat r2:<bucket>/simple/manifest-v1.json | head
```

Verify the Worker is bound to the correct bucket (Terraform state / Worker binding).

#### A project page is empty
The artifacts might not match expected filename patterns. Check manifest contents for that project key.

#### Upload is slow
rclone options to consider:

- increase `--transfers` and `--checkers`
- remove `--checksum` if mtimes are stable

### Security notes
- Public reads are handled by Cloudflare + Worker.
- Your R2 credentials stay only on your build server (for uploads).
- Cloudflare automatically provides edge protection in front of Workers.

## License
MIT 
